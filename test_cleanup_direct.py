#!/usr/bin/env python3
"""
Test direct des fonctions cleanup sans d√©pendre du serveur web
"""

import sys
import os

# Ajouter le r√©pertoire src au PYTHONPATH
sys.path.insert(0, '/home/kesurof/Projet_Gihtub/Redriva/src')

try:
    from symlink_tool import TorrentCleanupAnalyzer, init_symlink_database
    
    def test_cleanup_analyzer():
        """Test direct de la classe TorrentCleanupAnalyzer"""
        print("üß™ Test direct de TorrentCleanupAnalyzer...")
        
        try:
            # Initialiser la base de donn√©es
            init_symlink_database()
            print("‚úÖ Base de donn√©es initialis√©e")
            
            # Cr√©er une instance de l'analyseur
            analyzer = TorrentCleanupAnalyzer()
            print("‚úÖ TorrentCleanupAnalyzer instanci√©")
            
            # Test de la connexion Zurg
            zurg_result = analyzer.test_zurg_connection()
            print(f"üîç Test Zurg: {zurg_result}")
            
            # Test de scan Zurg (m√™me si le montage n'existe pas)
            used_torrents = analyzer.scan_zurg_usage()
            print(f"‚úÖ Scan Zurg r√©ussi: {len(used_torrents)} torrents utilis√©s")
            
            # Test de normalisation des noms
            test_name = "Test.Movie.2023.1080p.BluRay.x264-GROUP"
            normalized = analyzer.normalize_torrent_name(test_name)
            print(f"‚úÖ Normalisation: '{test_name}' -> '{normalized}'")
            
            # Test des fonctions de format
            formatted_size = analyzer._format_size(1024 * 1024 * 1024)  # 1GB
            print(f"‚úÖ Formatage taille: 1GB -> {formatted_size}")
            
            # Test de calcul d'√¢ge
            age = analyzer.calculate_age_days("2024-01-01 00:00:00")
            print(f"‚úÖ Calcul √¢ge: {age} jours depuis 2024-01-01")
            
            return True
            
        except Exception as e:
            print(f"‚ùå Erreur test analyzer: {e}")
            return False
    
    def test_database_functions():
        """Test des fonctions de base de donn√©es"""
        print("\nüíæ Test des fonctions de base de donn√©es...")
        
        try:
            import sqlite3
            
            db_path = '/home/kesurof/Projet_Gihtub/Redriva/data/symlink.db'
            conn = sqlite3.connect(db_path)
            cursor = conn.cursor()
            
            # Test d'insertion d'une configuration par d√©faut
            cursor.execute("DELETE FROM symlink_config")  # Nettoyer
            cursor.execute("""
                INSERT INTO symlink_config (
                    media_path, max_workers, cleanup_enabled, zurg_path, cleanup_min_age_days
                ) VALUES (?, ?, ?, ?, ?)
            """, ('/app/medias', 6, 1, '/home/kesurof/seedbox/zurg/__all__', 2))
            
            conn.commit()
            
            # Test de lecture
            cursor.execute("SELECT * FROM symlink_config LIMIT 1")
            row = cursor.fetchone()
            
            if row:
                columns = [description[0] for description in cursor.description]
                config = dict(zip(columns, row))
                print(f"‚úÖ Configuration test ins√©r√©e et lue: {len(config)} param√®tres")
                
                # V√©rifier les nouveaux champs cleanup
                cleanup_fields = ['cleanup_enabled', 'zurg_path', 'cleanup_min_age_days']
                missing_fields = [field for field in cleanup_fields if field not in config]
                
                if missing_fields:
                    print(f"‚ùå Champs manquants: {missing_fields}")
                    return False
                else:
                    print("‚úÖ Tous les champs cleanup pr√©sents")
                    return True
            else:
                print("‚ùå Impossible de lire la configuration")
                return False
                
            conn.close()
            
        except Exception as e:
            print(f"‚ùå Erreur test DB: {e}")
            return False
    
    def main():
        print("üß™ Test direct des fonctions cleanup")
        print("=" * 50)
        
        # Test de la base de donn√©es
        db_success = test_database_functions()
        
        # Test de l'analyseur
        analyzer_success = test_cleanup_analyzer()
        
        print("\n" + "=" * 50)
        print("üìä R√âSULTATS")
        print("=" * 50)
        
        print(f"   {'‚úÖ R√âUSSI' if db_success else '‚ùå √âCHEC':<12} Base de donn√©es")
        print(f"   {'‚úÖ R√âUSSI' if analyzer_success else '‚ùå √âCHEC':<12} TorrentCleanupAnalyzer")
        
        if db_success and analyzer_success:
            print("\nüéâ Tous les tests directs sont r√©ussis !")
            print("üìù Note: Les endpoints API n√©cessitent un red√©marrage du serveur")
            return True
        else:
            print("\n‚ùå Certains tests ont √©chou√©")
            return False
    
    if __name__ == "__main__":
        success = main()
        sys.exit(0 if success else 1)
        
except ImportError as e:
    print(f"‚ùå Erreur d'import: {e}")
    print("üìù Assurez-vous que le module symlink_tool est accessible")
    sys.exit(1)
